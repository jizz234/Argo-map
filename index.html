<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Navy Assistant ‚Äì Argo Floats</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: #0e1117;
      color: #e6edf3;
    }

    #map {
      height: 100%;
      width: 100%;
      background: #0e1117;
      display: none; /* hidden until user opens map */
    }

    /* Toolbar */
    #toolbar {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 23, 30, 0.9);
      padding: 10px 14px;
      border-radius: 50px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.6);
      display: none; /* hidden until map is open */
      gap: 10px;
      z-index: 1000;
      align-items: center;
      backdrop-filter: blur(12px);
    }
    .field {
      display: flex;
      align-items: center;
      background: #1c212c;
      border-radius: 30px;
      padding: 6px 12px;
      border: 1px solid #2d333b;
    }
    .field input {
      border: none;
      background: transparent;
      outline: none;
      font-size: 14px;
      min-width: 120px;
      color: #e6edf3;
    }
    .field input::placeholder { color: #8b949e; }

    /* Buttons */
    button {
      padding: 8px 16px;
      border-radius: 30px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #1f6feb, #238636);
      color: white;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 14px rgba(0,0,0,0.6);
    }

    /* Chatbot container */
    #chatbot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      max-height: 500px;
      display: flex; /* shown by default */
      flex-direction: column;
      border-radius: 12px;
      overflow: hidden;
      background: #161b22;
      border: 1px solid #30363d;
      box-shadow: 0 4px 18px rgba(0,0,0,0.7);
      z-index: 2000;
    }

    #chatHeader {
      background: #1f6feb;
      padding: 10px;
      color: white;
      font-weight: bold;
      font-family: "Inter", sans-serif;
    }

    #chatMessages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      font-size: 14px;
      color: #e6edf3;
      background: #0e1117;
    }

    #chatInput {
      display: flex;
      border-top: 1px solid #30363d;
      background: #161b22;
    }

    #chatInput input {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
      font-size: 14px;
      background: #0e1117;
      color: #e6edf3;
    }

    #chatInput button {
      padding: 10px 14px;
      border: none;
      cursor: pointer;
      background: #1f6feb;
      color: white;
      font-weight: bold;
    }
    #chatInput button:hover { background: #238636; }

    /* Floating button */
    #chatToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: #1f6feb;
      color: white;
      border-radius: 50%;
      display: none; /* hidden until map is open */
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      z-index: 2001;
    }
    #chatToggle:hover { background: #238636; }

    /* Popup cards */
    .popup-card {
      font-family: "Inter", "Segoe UI", sans-serif;
      min-width: 220px;
      max-width: 260px;
      background: #161b22;
      color: #e6edf3;
      border-radius: 8px;
      padding: 6px;
    }
    .popup-header {
      font-weight: bold;
      color: #58a6ff;
      font-size: 15px;
      margin-bottom: 6px;
      border-bottom: 1px solid #30363d;
      padding-bottom: 4px;
    }
    .popup-row { margin: 3px 0; }
    .popup-data {
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .data-box {
      flex: 1;
      text-align: center;
      background: #1c212c;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 6px;
      font-size: 13px;
    }
    .data-box .value { font-size: 14px; font-weight: bold; color: #79c0ff; }

    /* Leaflet popup dark theme */
    .leaflet-popup-content-wrapper {
      background: #161b22 !important;
      color: #e6edf3 !important;
      border-radius: 8px;
      border: 1px solid #30363d !important;
    }
    .leaflet-popup-tip { background: #161b22 !important; border: 1px solid #30363d !important; }
  </style>
</head>
<body>
  <!-- Toolbar -->
  <div id="toolbar">
    <div class="field">
      <input type="text" id="searchBox" placeholder="üîç Search float..." />
    </div>
    <div class="field">
      <label style="margin-right:6px;">Max age:</label>
      <input type="range" id="ageDays" min="1" max="365" value="90">
      <span id="ageLabel">90</span>d
    </div>
    <button id="reloadBtn">Reload</button>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Chatbot (default open) -->
  <div id="chatbot">
    <div id="chatHeader">Navy Assistant</div>
    <div id="chatMessages">
      <div><b>Bot:</b> Welcome, sailor üëã Do you want to see the map of Argo floats?</div>
    </div>
    <div id="chatInput">
      <input type="text" id="chatText" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
    <button id="openMapBtn" style="margin:10px;">üåç Open Map</button>
  </div>

  <!-- Floating button -->
  <div id="chatToggle">üí¨</div>

<script>
  // --- SAMPLE FLOAT DATA ---
  const sampleFloats = [
    { lat: 37.7749, lon: -122.4194, platform: "490001", country: "USA", project: "Argo", time: "2025-08-25T12:00:00Z", temperature: 14.2, salinity: 35.1 },
    { lat: -33.8688, lon: 151.2093, platform: "490002", country: "Australia", project: "Argo", time: "2025-08-20T15:30:00Z", temperature: 18.5, salinity: 34.8 },
    { lat: 35.6895, lon: 139.6917, platform: "490003", country: "Japan", project: "Argo", time: "2025-08-18T09:15:00Z", temperature: 20.1, salinity: 34.6 }
  ];

  // --- MAP SETUP ---
  const map = L.map('map', { worldCopyJump: true, minZoom: 2 }).setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'¬© OpenStreetMap', maxZoom: 7 }).addTo(map);
  const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 6, chunkedLoading: true });
  map.addLayer(cluster);

  function renderFloats() {
    cluster.clearLayers();
    const maxAge = +document.getElementById("ageDays").value;
    const search = document.getElementById("searchBox").value.trim().toLowerCase();

    sampleFloats.forEach(f => {
      const ageDays = (Date.now() - new Date(f.time)) / 864e5;
      if (ageDays > maxAge) return;
      if (search && !f.country.toLowerCase().includes(search) && !f.platform.includes(search)) return;

      const marker = L.circleMarker([f.lat, f.lon], {
        radius: 6,
        fillColor: ageDays <= maxAge ? "#3eea9a" : "#ffaa4d",
        color: "#00151f",
        weight: 1,
        fillOpacity: 0.9
      });

      marker.bindPopup(`
        <div class="popup-card">
          <div class="popup-header">Argo Float #${f.platform}</div>
          <div class="popup-row"><b>Country:</b> ${f.country}</div>
          <div class="popup-row"><b>Project:</b> ${f.project}</div>
          <div class="popup-row"><b>Last Report:</b> ${new Date(f.time).toLocaleString()}</div>
          <div class="popup-row"><b>Position:</b> ${f.lat.toFixed(4)}, ${f.lon.toFixed(4)}</div>
          <div class="popup-data">
            <div class="data-box"><div>üå° Temp</div><div class="value">${f.temperature}¬∞C</div></div>
            <div class="data-box"><div>üßÇ Salinity</div><div class="value">${f.salinity}</div></div>
          </div>
        </div>
      `);

      cluster.addLayer(marker);
    });
  }

  // --- CUSTOM PINS ---
  const customPins = [];
  map.on("click", e => {
    const { lat, lng } = e.latlng;
    const marker = L.marker([lat, lng], { draggable: true }).addTo(map);
    marker.bindPopup(`
      <div class="popup-card">
        <div class="popup-header">üìç Custom Pin</div>
        <div class="popup-row"><b>Lat:</b> ${lat.toFixed(4)}</div>
        <div class="popup-row"><b>Lng:</b> ${lng.toFixed(4)}</div>
        <button onclick="deleteCustomPin(${customPins.length})">Delete Pin</button>
      </div>
    `);
    customPins.push(marker);
  });
  function deleteCustomPin(index) {
    if (customPins[index]) {
      map.removeLayer(customPins[index]);
      customPins[index] = null;
    }
  }

  // --- CHAT & TOGGLE LOGIC ---
  const chatbot = document.getElementById("chatbot");
  const mapDiv = document.getElementById("map");
  const toolbar = document.getElementById("toolbar");
  const chatToggle = document.getElementById("chatToggle");
  const openMapBtn = document.getElementById("openMapBtn");
  const chatMessages = document.getElementById("chatMessages");
  const chatText = document.getElementById("chatText");
  const sendBtn = document.getElementById("sendBtn");

  openMapBtn.onclick = () => {
    chatbot.style.display = "none";
    mapDiv.style.display = "block";
    toolbar.style.display = "flex";
    chatToggle.style.display = "flex";
    renderFloats();
  };

  chatToggle.onclick = () => {
    chatbot.style.display = "flex";
    mapDiv.style.display = "none";
    toolbar.style.display = "none";
    chatToggle.style.display = "none";
  };

  sendBtn.onclick = () => {
    const msg = chatText.value.trim();
    if (!msg) return;
    chatMessages.innerHTML += `<div><b>You:</b> ${msg}</div>`;
    chatMessages.innerHTML += `<div><b>Bot:</b> I'm just a demo ü§ñ. Click üåç Open Map to see floats.</div>`;
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatText.value = "";
  };
  chatText.addEventListener("keydown", e => { if (e.key === "Enter") sendBtn.click(); });
</script>
</body>
</html>
